<!DOCTYPE html>
<html>
  <head>
    <title>Auditory N-Back</title>



	<link href="lib/vendors/jspsych-6.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />
	<link href="nbstyle.css" rel="stylesheet" type="text/css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-6.0.2/jspsych.js"></script>

	<script src="jspsych-6.0.2/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.0.2/plugins/jspsych-html-button-response.js"></script>

	<link href="jspsych-6.0.2/css/jspsych.css" rel="stylesheet" type="text/css">


	<script>

    function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
    }
    function getUrlParam(parameter, defaultvalue){
      var urlparameter = defaultvalue;
      if(window.location.href.indexOf(parameter) > -1){
          urlparameter = getUrlVars()[parameter];
          }
      return urlparameter;
    }

    var sid = getUrlParam('sid', 'na')
    var gid = getUrlParam('gid', 'na')
		var userip; // get user IP for purposes of checking duplicate responses
		var timestamp = new Date(); //timestamp of participation
		var today = new Date();
		var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
		var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();

		jsPsych.data.addProperties({Date: date}); //add date to data output
		jsPsych.data.addProperties({Time: time}); //add time to data output

    </script>

  </head>
  <body>

  <script>

/////////////////////
// DEFINE TIMELINE //
/////////////////////

var timeline = [];


/********************************/
/***** Auditory N-Back Task *****/
/********************************/

/*
In this part of the script, participants complete several runs of an auditory n-back
task. There are three sound types -- Bohlen-Pierce chords, Shepard tones, and cat
sounds. The Bohlen-Pierce and cat sounds should be difficult to verbalize for all
participants, regardless of pitch naming ability, so they are used in the current
study. Participants complete one run (30 scored trials) of the 1-back, and 2 runs
of both the 2-back and 3-back for each sound type. These variables are easy to
change (e.g., presenting a higher n, removing runs etc.)
*/

//General parameters for the n-back

var defaultITI = 500; // default inter-trial-interval
var presentationRate = 2500; // presentation rate between items in the n-back
var NUM_NON_TARGETS = 20; // number of non-targets per run
var NUM_TARGETS = 10; // number of targets per run

var NB_SEQUENCE = [3,3,3]; // critical - this specifies the number of runs and the level (n)...e.g., [1,2,3] would be one run of each 1-back, 2-back, and 3-back (in order)
var NB_INDEX = 0; //selection index for nb sequence
var TRIAL_INDEX; //selection index for the trials within an n-back run
var run_sequence;

var HIT_1 = 0; //counter of total hits for 1-back
var HIT_2 = 0; //counter of total hits for 2-back
var HIT_3 = 0; //counter of total hits for 3-back

var FA_1 = 0; //counter of total false alarms for 1-back
var FA_2 = 0; //counter of total false alarms for 2-back
var FA_3 = 0; //counter of total false alarms for 3-back

var anb_letters = ['ANB_Letters/1.wav', 'ANB_Letters/2.wav', 'ANB_Letters/3.wav', 'ANB_Letters/4.wav', 'ANB_Letters/5.wav', 'ANB_Letters/6.wav', 'ANB_Letters/7.wav', 'ANB_Letters/8.wav'];
var n;

/* Returns one random stimulus with replacement*/
   function getSample(stimList) {
        return jsPsych.randomization.sampleWithReplacement(stimList, 1);
      }


/////////////////////////////////////////////////////
// Reminder of N-Back Run, Preparation of Sequence //
/////////////////////////////////////////////////////

	  var instrBack = {
			type: "html-button-response",
			stimulus: function(){n = NB_SEQUENCE[NB_INDEX]; return'<p>You will now complete a <strong>'+n+'-back.</strong></p><p>Remember, this means that you should press SPACEBAR every time the sound you hear matches the one presented <strong>'+n+'</strong> positions previously.</p>';},
		    choices: ['Continue'],
			button_html: '<button class="buttonStyle">%choice%</button>',
			on_start: function(){
				n = NB_SEQUENCE[NB_INDEX]; //this selects the level (n) from the array defined at the beginning
				TRIAL_INDEX = 0; //trial index is reset prior to each run
				var audioStimuli = []; //this is the array that will hold the sequence of sounds
				//now we push three trial types to an array (finalArray) - first n trials (FIRSTS), non-targets (NT) and targets (T)
				var FIRSTS = ["FIRSTS"];
				var NT = ["NT"];
				var T = ["T"];
				var FIRSTS2 = jsPsych.randomization.repeat(FIRSTS, n);
				var NT2 = jsPsych.randomization.repeat(NT, NUM_NON_TARGETS);
				var T2 = jsPsych.randomization.repeat(T, NUM_TARGETS);
				var TESTTRIALS = NT2.concat(T2);
				var TESTTRIALS_SHUFFLED = jsPsych.randomization.repeat(TESTTRIALS, 1); // randomize the combined array of targets and non-targets
				var finalArray = [];


				for (i = 0;  i < FIRSTS2.length; i++) {
					finalArray.push(FIRSTS2[i]) //push first trials to the final array
				};

				for (i = 0;  i < TESTTRIALS_SHUFFLED.length; i++) {
					finalArray.push(TESTTRIALS_SHUFFLED[i]) //push randomized target/non-target (i.e., the scored trials) to the array after the first trials)
				};

				var audioTarget;
				var audioSample;

				for (var i = 0; i < finalArray.length; i++) {
					if (finalArray[i] == "FIRSTS") {
						audioStimuli.push(getSample(anb_letters ));
					} else {
						audioTarget = audioStimuli[i-n];
						audioSample = audioTarget;

		   // if the trial type is NT, the script removes the target stim from the array, selects a sound, then puts the target back into the array
				if (finalArray[i] == "NT") {
					for( var j = 0; j < anb_letters.length; j++){
						if ( anb_letters[j] == audioTarget) {
							target_temp = anb_letters.slice(j, j+1); //temporary store for the target
							anb_letters.splice(j, 1); //array of sounds minus the target
							}
						audioSample = getSample(anb_letters);
						}
					anb_letters.push(target_temp[0]);
					}
				audioStimuli.push(audioSample);
				}
			}
			run_sequence = {audio: audioStimuli, type: finalArray};
		}
    };


///////////////////////////////
// Letter Presentation Trial //
///////////////////////////////

	var nb_trial = {
		type: "audio-keyboard-response",
		stimulus: function(){return run_sequence.audio[TRIAL_INDEX];},
        trial_duration: presentationRate,
        choices: [' '],
        response_ends_trial: false,
        on_finish: function (trialData) {
            var rt = JSON.parse(trialData.rt);
			var keyresp = JSON.parse(trialData.key_press);
			var wasatarget = (run_sequence.type[TRIAL_INDEX] == "T") ? 1 : 0;
			var ttype = run_sequence.type[TRIAL_INDEX];
			var n_level = n;
            var rtAudio = rt;
			var HIT;
			var FA;
			TRIAL_INDEX += 1;

			//calculate hits and false alarms for each trial
			if (wasatarget === 1) {
				if (keyresp == 32) {
					HIT = 1;
				if (n_level == 1) {
					HIT_1 += 1;
				} else if (n_level == 2) {
					HIT_2 += 1;
				} else {
					HIT_3 += 1;
				}
				} else {
					HIT = 0;
			}
			  } else if (wasatarget === 0){
				if (keyresp == 32) {
				FA = 1;
				if (n_level == 1) {
					FA_1 += 1;
				} else if (n_level == 2) {
					FA_2 += 1;
				} else {
					FA_3 += 1;
				}
			} else {
				FA = 0;
			}

			 } else {
				HIT = '';
				FA = '';
			 }

              var extraData = {
                rt_audio: rtAudio,
				designation: 'n-back-trial',
                responded_to_audio: (rtAudio == null ? 0 : 1),
				N: n_level,
				TYPE: ttype,
				HIT: HIT,
				FA:FA
              };
              jsPsych.data.addDataToLastTrial(extraData);
            }
          };


//looping function to repeat the trial for the length of the stim array (30 + n)
	var trial_loop_node = {
		timeline: [nb_trial],
		loop_function: function(data){
			if(typeof run_sequence.type[TRIAL_INDEX] !== "undefined"){
				return true;
			} else {
				return false;
			}
		}
	}



	var shortBreak = {
		type: "html-button-response",
		stimulus: '<p>You may take a short break if you wish.</p><p>Click the button below when you are ready to continue.</p>',
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		on_finish: function(){
			NB_INDEX += 1; //this advances the index to search for the next 'n' level in NB_SEQUENCE

		}
    };

//looping function to repeat n-back runs until 'NB_SEQUENCE' runs out
	var anb_loop_node = {
		timeline: [instrBack, trial_loop_node, shortBreak],
		loop_function: function(data){
			if(typeof NB_SEQUENCE[NB_INDEX] !== "undefined"){
				return true;
			} else {
				return false;
			}
		}
	}



/*************************/
/** N-Back Instructions **/
/*************************/

var anb_inst_1 = {
        type: "html-button-response",
        stimulus: '<p>You will now complete an auditory memory task. This will take approximately 15 minutes.</p><p>To learn more about the task, please advance to the next screen.',
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };

var anb_inst_2 = {
        type: "html-button-response",
        stimulus: '<p>In this task, you will hear a sequence of spoken letters. The letters will be spoken one at a time, and a new letter will be spoken every 2.5 seconds.</p>' +
				  '<p>Your job is to listen closely to these letters for specific kinds of <b>repeats</b>.</p>',
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };

var anb_inst_3 = {
        type: "html-button-response",
        stimulus: '<p>If you are asked to complete a <b>1-back</b>, you must press SPACEBAR every time the current letter matches the letter presented <b>one</b> position previously.<br>' +
				  "Otherwise, you do not have to respond.</p><p>For example, imagine you heard the following sound sequence:</p><p style='color:darkblue'>B...D...<b style='color:red'>D</b>...F...<b style='color:red'>F</b>...<b style='color:red'>F</b>...C...E...</p>" +
				  "<p>You would respond to the sounds printed in <b style='color:red'>red</b>, as these were repeated <b>one</b> position previously.</p>",
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };

var anb_inst_4 = {
        type: "html-button-response",
        stimulus: '<p>If you are asked to complete a <b>2-back</b>, you must press SPACEBAR every time the current sound matches the sound presented <b>two</b> positions previously.<br>' +
				  "Otherwise, you do not have to respond.</p><p>For example, imagine you heard the following sound sequence:</p><p style='color:darkblue'>B...D...<b style='color:red'>B</b>...C...<b style='color:red'>B</b>...<b style='color:red'>C</b>...E...F...</p>" +
				  "<p>You would respond to the sounds printed in <b style='color:red'>red</b>, as these were repeated <b>two</b> positions previously.</p>",
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };

var anb_inst_5 = {
        type: "html-button-response",
        stimulus: '<p>If you are asked to complete a <b>3-back</b>, you must press SPACEBAR every time the current sound matches the sound presented <b>three</b> positions previously.<br>' +
				  "Otherwise, you do not have to respond.</p><p>For example, imagine you heard the following sound sequence:</p><p style='color:darkblue'>B...D...G...<b style='color:red'>B</b>...<b style='color:red'>D</b>...C...E...<b style='color:red'>D</b>...</p>" +
				  "<p>You would respond to the sounds printed in <b style='color:red'>red</b>, as these were repeated <b>three</b> positions previously.</p>",
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };

var anb_inst_6 = {
        type: "html-button-response",
        stimulus: '<p>As you can imagine, the task is a bit tricky.</p>' +
				  '<p>Please make sure you are in a quiet listening environment and free from distraction.<br>You will receive breaks approximately every 90 seconds to minimize fatigue.</p>',
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };


var anb_inst_7 = {
        type: "html-button-response",
        stimulus: '<p>This concludes the introduction to the memory task.</p>'+
				  '<p>Please advance to the next screen to receive further instructions.</p>',
		choices: ['Begin'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		post_trial_gap: 250
    };


var anb_instruct_final = {
	timeline: [anb_inst_1, anb_inst_2, anb_inst_5, anb_inst_6, anb_inst_7]
};




//N-Back Wrap-Up
    var anb_wrapup = {
        type: "html-button-response",
        stimulus: "<p>This concludes the auditory memory task.</p><p>To see a summary of your performance, continue to the next screen.",
		choices: ['Continue'],
		button_html: '<button class="buttonStyle">%choice%</button>',
		on_finish: function(data){

			jsPsych.data.addDataToLastTrial({
			  designation: "ANB-SUMMARY",
			  HIT_1B: HIT_1,
			  HIT_2B: HIT_2,
			  HIT_3B: HIT_3,
			  FA_1B: FA_1,
			  FA_2B: FA_2,
			  FA_3B: FA_3
            });

		}
      };



var anb_timeline_final = {
	timeline: [anb_instruct_final, anb_loop_node, anb_wrapup]
}


timeline.push(anb_timeline_final);

/***************************/
/***** General Wrap-Up *****/
/***************************/


//N-Back Wrap-Up
    var goodbye = {
        type: "html-button-response",
        stimulus: function(){
				var pageText = 	'<p>Here is a short summary of your performance:</br></p>' +
								'<p>For the <b>3-back</b>, you had ' + HIT_3 + ' of 30 possible HITS and  ' + FA_3 + ' of 60 possible FALSE ALARMS.</p>';
				return [pageText];
						},
		choices: ['Exit'],
		button_html: '<button class="buttonStyle">%choice%</button>'
      };

      timeline.push(goodbye);
      function on_end(){
        var hits = HIT_3;
        var fas = FA_3;
        var URL = "https://ssd.az1.qualtrics.com/jfe/form/SV_dmv2EB5errcAJdb?subid="+sid+"&gid="+gid+"&hits="+hits+"&fas="+fas;
        return URL;
      }

     jsPsych.init({
        timeline: timeline,
		    preload_audio: anb_letters,
        on_finish: function () {
                url = on_end();
                document.body.innerHTML = '<p> Please wait. You will be redirected back to Prolific in a few moments. <p>If you are not, click <a href="'+url+'">here</a>. </p>'
                setTimeout(function () { location.href = url }, 2000)
            },
      });

    </script>
  </body>
</html>
